<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Debug — Family Drawer (Draw Only)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://www.desmos.com/api/v1.6/calculator.js" defer></script>
<style>
  body{font-family:system-ui;margin:0;background:#f7fafc;color:#0f172a}
  header{padding:14px;background:linear-gradient(90deg,#0ea5a4,#3b82f6);color:#fff;font-weight:600}
  .page{display:flex;gap:20px;padding:18px}
  .left{width:360px;background:#fff;padding:16px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .right{flex:1;background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:720px}
  textarea{width:100%;min-height:80px;font-family:monospace;padding:8px;border-radius:6px;border:1px solid #e6e6e6}
  input[type=number]{width:100px;padding:6px;border-radius:6px;border:1px solid #e6e6e6}
  button{padding:8px 12px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer}
  #calculator,#desmos-fallback{width:100%;height:700px;border-radius:6px;border:1px solid #e6e6e6}
</style>
</head>
<body>
<header>Orthogonal Trajectories — Debug Family Drawer</header>
<div class="page">
  <div class="left">
    <label>Equation (x,y; Desmos/LaTeX)</label>
    <textarea id="equation">x^2 + y^2 = k</textarea>

    <label style="margin-top:10px">Parameter sweep (applies to ALL detected parameters)</label>
    <div style="display:flex;gap:8px;margin:8px 0 12px">
      <div><small>min</small><input id="pmin" type="number" value="1" step="0.5"></div>
      <div><small>max</small><input id="pmax" type="number" value="30" step="0.5"></div>
      <div><small>step</small><input id="pstep" type="number" value="1" step="0.1"></div>
    </div>

    <div><button id="draw">Draw Family</button></div>

    <hr>
    <small>Open DevTools Console (F12) and click Draw. Console will show debug logs. Paste logs here if it still fails.</small>
  </div>

  <div class="right">
    <div id="calculator"></div>
    <iframe id="desmos-fallback" src="about:blank" style="display:none"></iframe>
  </div>
</div>

<script>
(function(){
  // debug helpers
  function log(msg){ try{ console.log('[DFD] ' + msg); }catch(e){} }
  function err(msg){ try{ console.error('[DFD] ' + msg); }catch(e){} }

  function showFallback(){
    log('Showing iframe fallback');
    document.getElementById('calculator').style.display='none';
    const iframe = document.getElementById('desmos-fallback'); iframe.style.display='block'; iframe.src='https://www.desmos.com/calculator';
  }

  // find parameter tokens
  function findParams(latex){
    const reserved = new Set(['x','y','e','pi','ln','log','sin','cos','tan','sqrt','abs','exp','frac','mod','min','max']);
    const tokens = (latex.match(/[a-zA-Z]\w*/g) || []);
    const params = [];
    for(const t of tokens){
      if(!reserved.has(t) && !params.includes(t)) params.push(t);
    }
    return params;
  }

  function frange(min,max,step){
    const out=[]; if(step===0) return out;
    const sign = step>0?1:-1; let v=min; const limit=max + sign*1e-12;
    while((step>0 && v<=limit) || (step<0 && v>=limit)){ out.push(Math.round(v*1e12)/1e12); v+=step; if(out.length>5000) break; }
    return out;
  }

  function cartesian(arrays){ return arrays.reduce((acc, arr)=>{ const res=[]; for(const a of acc){ for(const b of arr){ res.push(a.concat([b])); } } return res; }, [[]]); }

  function substituteParam(latex, name, value){
    // boundary-aware replace (avoid partial matches)
    const esc = name.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
    const re = new RegExp('(^|[^A-Za-z0-9_])' + esc + '([^A-Za-z0-9_]|$)','g');
    return latex.replace(re, function(_, g1, g2){ return (g1||'') + '(' + String(value) + ')' + (g2||''); });
  }

  window.addEventListener('load', function(){
    log('Window loaded');
    const calcDiv = document.getElementById('calculator');
    if(typeof Desmos === 'undefined'){
      log('Desmos not yet defined; waiting 700ms');
      setTimeout(function(){ if(typeof Desmos === 'undefined'){ log('Desmos still undefined -> fallback'); showFallback(); } else init(); },700);
    } else init();

    function init(){
      log('Initializing Desmos');
      let calculator;
      try{
        calculator = Desmos.GraphingCalculator(calcDiv,{expressions:true,keypad:false,settingsMenu:true});
      }catch(e){
        err('Desmos init failed: '+ e);
        showFallback(); return;
      }
      try{ calculator.setMathBounds({left:-30,right:130,bottom:-50,top:50}); }catch(e){}

      // Attach click handler reliably
      const drawBtn = document.getElementById('draw');
      drawBtn.onclick = function(){
        try{
          log('Draw clicked');
          const raw = document.getElementById('equation').value.trim();
          log('Raw equation: ' + raw);
          if(!raw){ alert('Enter an equation'); return; }

          const params = findParams(raw).filter(p=>p!=='x' && p!=='y');
          log('Detected params: ' + JSON.stringify(params));
          const pmin = parseFloat(document.getElementById('pmin').value) || 0;
          const pmax = parseFloat(document.getElementById('pmax').value) || 0;
          let pstep = parseFloat(document.getElementById('pstep').value); if(!isFinite(pstep)||pstep===0) pstep=1;
          log('Range: ' + pmin + ' .. ' + pmax + ' step ' + pstep);

          const paramLists = {};
          for(const p of params) paramLists[p] = frange(pmin,pmax,pstep);
          log('Param lists lengths: ' + JSON.stringify(Object.fromEntries(Object.entries(paramLists).map(([k,v])=>[k,v.length]))));

          let combos = [[]];
          if(params.length>0){
            const arrays = params.map(p=>paramLists[p]);
            combos = cartesian(arrays);
          }
          log('Combos count: ' + combos.length);

          const MAX = 300;
          if(combos.length > MAX){ alert('Too many curves: '+combos.length + '. Increase step or reduce range (max ' + MAX + ')'); return; }

          const exprs = [];
          if(params.length===0){
            exprs.push({id:'eq0', latex:raw, color:Desmos.Colors.BLUE});
          } else {
            for(let i=0;i<combos.length;i++){
              let sub = raw;
              for(let j=0;j<params.length;j++){
                sub = substituteParam(sub, params[j], combos[i][j]);
              }
              log('Substituted['+i+']: ' + sub);
              exprs.push({id:'eq_'+i, latex:sub, color: (i%3===0?Desmos.Colors.BLUE: (i%3===1?Desmos.Colors.PURPLE:Desmos.Colors.RED))});
            }
          }

          log('Clearing old expressions and setting new ('+exprs.length+' items)');
          calculator.setExpressions([]); // clear
          calculator.setExpressions(exprs);
          alert('Plotted ' + exprs.length + ' curve(s). Check graph (and console for logs).');
        }catch(e){
          err('Error in draw handler: ' + e);
          alert('Error while drawing. See console logs.');
        }
      }; // end onclick

      log('Draw handler attached');
    } // end init
  });
})();
</script>
</body>
</html>
