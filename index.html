<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orthogonal Trajectories — Family Drawer (Draw Only)</title>

  <!-- Desmos API loaded with defer -->
  <script src="https://www.desmos.com/api/v1.6/calculator.js" defer></script>

  <style>
    body { margin:0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:#f7fafc; color:#0f172a; }
    header { padding: 14px; background: linear-gradient(90deg,#0ea5a4,#3b82f6); color:white; font-weight:600; }
    .page { display:flex; gap:20px; padding:18px; }
    .left { width:360px; background:white; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(15,23,42,0.06); }
    .right { flex:1; background:white; padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(15,23,42,0.06); min-height:720px; }
    #calculator, #desmos-fallback { width:100%; height:700px; border-radius:6px; border:1px solid #e6e6e6; background:white; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    textarea { width:100%; min-height:80px; font-family:monospace; padding:8px; box-sizing:border-box; border-radius:6px; border:1px solid #e6e6e6; }
    input[type=number] { width:100px; padding:6px; border-radius:6px; border:1px solid #e6e6e6; }
    .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    button { padding:8px 12px; background:#3b82f6; color:white; border:none; border-radius:6px; cursor:pointer; margin-right:8px; }
    small.note { color:#64748b; display:block; margin-top:8px; font-size:13px; }
  </style>
</head>
<body>
  <header>Orthogonal Trajectories — Family Drawer</header>

  <div class="page">
    <div class="left">
      <label for="equation">Equation (use x and y; Desmos/LaTeX syntax)</label>
      <textarea id="equation">x^2 + y^2 = k</textarea>
      <small class="note">Examples: <code>x^2 + y^2 = k</code>, <code>y = c*sin(x)</code>, <code>y + ln(|x|)/(2k) = c</code></small>

      <label>Parameter sweep (applies to ALL detected parameters)</label>
      <div class="row">
        <div>
          <small>min</small>
          <input id="pmin" type="number" value="1" step="0.5">
        </div>
        <div>
          <small>max</small>
          <input id="pmax" type="number" value="30" step="0.5">
        </div>
        <div>
          <small>step</small>
          <input id="pstep" type="number" value="1" step="0.1">
        </div>
      </div>

      <div style="margin-top:8px;">
        <button id="draw">Draw Family</button>
      </div>

      <hr/>

      <h4>Notes</h4>
      <small class="note">
        • The script detects identifiers other than <code>x</code> and <code>y</code> and treats them as parameters.<br>
        • It substitutes numeric values into the equation and sends many concrete equations to Desmos (so Desmos will not ask you to define the variable).<br>
        • To avoid overloading Desmos, total plotted curves are capped at <strong>300</strong>. Increase step or reduce range to draw fewer curves.<br>
        • If Desmos is blocked by an extension, the page falls back to an iframe of Desmos.
      </small>
    </div>

    <div class="right">
      <div id="calculator" aria-label="Desmos calculator container"></div>
      <iframe id="desmos-fallback" src="about:blank" style="display:none;"></iframe>
    </div>
  </div>

<script>
(function(){
  // robust token-finding (find identifiers that look like variables)
  function findParams(latex) {
    // exclude common math words
    const reserved = new Set([
      'x','y','e','pi','ln','log','sin','cos','tan','sqrt','abs','sec','csc','cot',
      'arcsin','arccos','arctan','exp','floor','ceil','frac','mod','min','max',
      'sin^{-1}','cos^{-1}','tan^{-1}'
    ]);
    // find letter-starting tokens
    const tokens = latex.match(/[a-zA-Z]\\w*/g) || [];
    const params = [];
    for(const t of tokens){
      if(!reserved.has(t) && !params.includes(t)) params.push(t);
    }
    return params;
  }

  function showFallback(){
    const calcDiv = document.getElementById('calculator');
    const iframe = document.getElementById('desmos-fallback');
    if(calcDiv) calcDiv.style.display = 'none';
    iframe.style.display = 'block';
    iframe.src = 'https://www.desmos.com/calculator';
  }

  // generate a float range inclusive of endpoints
  function frange(min, max, step){
    const out = [];
    if(step === 0) return out;
    // avoid infinite loop due to floating errors
    const sign = step > 0 ? 1 : -1;
    let v = min;
    const limit = max + sign * 1e-12;
    while((step > 0 && v <= limit) || (step < 0 && v >= limit)){
      // round to avoid long floating decimals
      out.push(Math.round(v * 1e12) / 1e12);
      v += step;
      // safety
      if(out.length > 10000) break;
    }
    return out;
  }

  // create cartesian product of arrays
  function cartesian(arrays){
    return arrays.reduce((acc, arr) => {
      const res = [];
      for(const a of acc){
        for(const b of arr){
          res.push(a.concat([b]));
        }
      }
      return res;
    }, [[]]);
  }

  // replace parameter names safely in latex string with numeric literal
  // uses boundary-aware regex: (^|[^A-Za-z0-9_])name([^A-Za-z0-9_]|$) -> preserve surrounding chars
  function substituteParam(latex, name, value){
    // escape name for regex
    const esc = name.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');
    const re = new RegExp('(^|[^A-Za-z0-9_])' + esc + '([^A-Za-z0-9_]|$)', 'g');
    // replacement keeps captured groups $1 and $2
    return latex.replace(re, function(_, g1, g2){
      return (g1 || '') + '(' + String(value) + ')' + (g2 || '');
    });
  }

  // initialize on window load
  window.addEventListener('load', function(){
    const calcDiv = document.getElementById('calculator');
    if(!calcDiv){ console.error('No calculator element'); showFallback(); return; }

    // wait for Desmos script to be available
    if(typeof Desmos === 'undefined'){
      setTimeout(function(){
        if(typeof Desmos === 'undefined'){
          console.warn('Desmos script missing; showing fallback iframe.');
          showFallback();
        } else {
          initCalc();
        }
      }, 600);
    } else {
      initCalc();
    }

    function initCalc(){
      let calculator;
      try {
        calculator = Desmos.GraphingCalculator(calcDiv, {expressions:true, keypad:false, settingsMenu:true});
      } catch(e){
        console.error('Desmos init error', e);
        showFallback();
        return;
      }

      // set a default viewport
      try { calculator.setMathBounds({left:-30, right:130, bottom:-50, top:50}); } catch(e){}

      const drawBtn = document.getElementById('draw');
      drawBtn.addEventListener('click', function(){
        const raw = document.getElementById('equation').value.trim();
        if(!raw){ alert('Please enter an equation.'); return; }

        // detect parameter names
        const params = findParams(raw).filter(p => p !== 'x' && p !== 'y');
        const pmin = parseFloat(document.getElementById('pmin').value) || 0;
        const pmax = parseFloat(document.getElementById('pmax').value) || 0;
        let pstep = parseFloat(document.getElementById('pstep').value);
        if(!isFinite(pstep) || pstep === 0) pstep = 1;

        // build numeric lists for each parameter
        const paramLists = {};
        for(const p of params){
          paramLists[p] = frange(pmin, pmax, pstep);
          if(paramLists[p].length === 0){
            alert('Parameter range for ' + p + ' produced no values. Check min/max/step.');
            return;
          }
        }

        // compute combos
        let combos = [[]];
        let paramNames = [];
        if(params.length > 0){
          paramNames = params.slice();
          const arrays = paramNames.map(n => paramLists[n]);
          combos = cartesian(arrays);
        }

        const MAX = 300;
        if(combos.length > MAX){
          alert('Too many curves (' + combos.length + '). Increase step or reduce range. Max ' + MAX + '.');
          return;
        }

        // build expressions by substituting numeric values
        const exprs = [];
        if(params.length === 0){
          exprs.push({ id: 'eq0', latex: raw, color: Desmos.Colors.BLUE });
        } else {
          for(let i=0;i<combos.length;i++){
            let sub = raw;
            for(let j=0;j<paramNames.length;j++){
              sub = substituteParam(sub, paramNames[j], combos[i][j]);
            }
            // add each equation (cycle colors for better visibility)
            const color = (i % 3 === 0) ? Desmos.Colors.BLUE : ((i % 3 === 1) ? Desmos.Colors.PURPLE : Desmos.Colors.RED);
            exprs.push({ id: 'eq_' + i, latex: sub, color: color });
          }
        }

        // clear prev and set
        try {
          calculator.setExpressions([]); // clear
          calculator.setExpressions(exprs);
        } catch(e){
          console.error('Failed to set expressions', e);
          alert('Failed to draw. Check equation syntax (Desmos LaTeX) and try again.');
        }
      });

      // initial draw (optional)
      // drawBtn.click();
    } // end initCalc
  });
})();
</script>
</body>
</html>
